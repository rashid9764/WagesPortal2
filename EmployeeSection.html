<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Employee Section</title>

  <!-- LIBRARIES -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom right, #a9d6ff, #e6f3ff);
      min-height: 100vh; display: flex; flex-direction: column; align-items: center;
      padding: 10px; overflow-x: hidden;
    }
    h1 { color: #0b3d91; font-size: 24px; font-weight: bold; margin: 15px 0 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }

    /* FILE NAME BAR */
    .browse-container {
      align-self: flex-start; margin-left: 20px; margin-bottom: 10px;
      display: flex; align-items: center; gap: 8px; font-size: 11px; color: #0b3d91;
    }
    #fileName { font-weight: bold; }
    #loadedFileName { font-size: 10px; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* TEXT BUTTONS */
    .text-btn, .info-btn {
      background: none; border: none; padding: 0; margin: 0 0 0 6px;
      font-size: 11px; color: #0b3d91; cursor: pointer; font-weight: bold;
      transition: color 0.2s ease;
    }
    .text-btn:hover, .info-btn:hover { color: #094080; }

    /* FORM - WIDER INPUTS & BUTTON */
    .form-container {
      background: transparent; border-radius: 12px; padding: 15px 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2); width: 90%; max-width: 420px;
    }
    .form-container label { font-weight: bold; color: #0b3d91; font-size: 14px; display: block; margin-bottom: 5px; }
    .label-with-info { display: flex; align-items: center; gap: 6px; font-weight: bold; color: #0b3d91; margin-top: 8px; }

    /* WIDER INPUTS */
    input, #searchBtn {
      width: 100% !important; padding: 10px; margin-top: 5px;
      border-radius: 8px; border: 1px solid #0b3d91; font-size: 14px;
    }
    #searchBtn {
      background: #0b3d91; color: white; border: none;
      font-weight: bold; cursor: pointer; box-shadow: 4px 6px 10px rgba(0,0,0,0.4);
      transition: 0.3s;
    }
    #searchBtn:hover { background: #094080; transform: scale(1.02); }

    /* TABLE */
    .table-container { width: 90%; max-width: 420px; margin-top: 20px; max-height: 350px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 4px 6px 10px rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 8px; font-size: 13px; }
    th { background: #0b3d91; color: white; position: sticky; top: 0; z-index: 1; }
    tr { cursor: pointer; }
    tr:hover { background: #f1f1f1; }
    tr.selected { background: #d1e7ff; }
    tfoot td { font-weight: bold; background: #f1f1f1; }

    /* BOTTOM BUTTONS */
    .button-container { display: flex; gap: 10px; margin: 10px 0 20px; justify-content: center; flex-wrap: wrap; }
    #downloadBtn, #correctionBtn {
      padding: 6px 12px; background: transparent; border: none; color: #0b3d91;
      border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    #downloadBtn:hover, #correctionBtn:hover { color: #094080; transform: scale(1.03); }

    /* HISTORY MODAL */
    .history-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .history-modal {
      background: white; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3); padding: 15px;
    }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #0b3d91; font-weight: bold; font-size: 1.1rem; }
    .close-history { background: none; border: none; font-size: 18px; color: #999; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: 0.2s; }
    .close-history:hover { background: #f0f0f0; color: #333; }
    .history-item { background: #f9f9f9; border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.9rem; line-height: 1.5; position: relative; }
    .history-item small { color: #666; display: block; margin-top: 5px; }
    .rtl { direction: rtl; text-align: right; font-family: 'Noto Nastaliq Urdu', Arial, sans-serif; }
    .no-history { text-align: center; color: #999; font-style: italic; padding: 20px; }
    .delete-complaint {
      position: absolute; bottom: 6px; right: 6px; background: #ff4d4d; color: white; border: none;
      font-size: 11px; font-weight: bold; width: 32px; height: 24px; border-radius: 6px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: 0.2s;
    }
    .delete-complaint:hover { background: #e60000; transform: scale(1.05); }
    .status-badge { display: inline-block; padding: 2px 6px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; margin-top: 4px; }
    .status-pending { background: #fff3cd; color: #d35400; }
    .status-verifying { background: #fffbe6; color: #f39c12; }
    .status-done { background: #d4edda; color: #27ae60; }

    /* CARD BUTTONS */
    .card-btn {
      background: #0b3d91; color: white; border: none; padding: 12px 18px;
      border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2); transition: 0.2s; margin: 4px;
      min-width: 120px;
    }
    .card-btn:hover { background: #094080; transform: translateY(-1px); }

    /* SCROLLBAR */
    .table-container::-webkit-scrollbar, .history-modal::-webkit-scrollbar { width: 8px; }
    .table-container::-webkit-scrollbar-track, .history-modal::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 8px; }
    .table-container::-webkit-scrollbar-thumb, .history-modal::-webkit-scrollbar-thumb { background: #0b3d91; border-radius: 8px; }
    .table-container::-webkit-scrollbar-thumb:hover, .history-modal::-webkit-scrollbar-thumb:hover { background: #094080; }

    /* RESPONSIVE */
    @media (max-width: 600px) {
      h1 { font-size: 20px; }
      .form-container { width: 95%; padding: 12px; }
      input, #searchBtn { font-size: 13px; padding: 9px; }
      .table-container { width: 95%; max-height: 320px; }
      th, td { font-size: 11px; padding: 6px; }
      #downloadBtn, #correctionBtn { font-size: 11px; padding: 5px 10px; }
      .browse-container { gap: 5px; font-size: 10px; }
      #loadedFileName { max-width: 120px; }
      .text-btn, .info-btn { font-size: 10px; }
      .history-modal { width: 95%; padding: 12px; }
      .delete-complaint { width: 28px; height: 22px; font-size: 10px; }
      .card-btn { padding: 10px 14px; font-size: 13px; min-width: 100px; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
</head>
<body>

  <h1>EMPLOYEE SECTION</h1>

  <div class="browse-container">
    <span id="fileName">Loaded File:</span>
    <span id="loadedFileName">No file loaded</span>
    <button class="text-btn" id="refreshFileBtn">Refresh</button>
  </div>

  <!-- WIDER INPUT FIELDS -->
  <div class="form-container">
    <label>Enter Your Code</label>
    <input type="text" id="code" placeholder="Enter Your Code">
    <button id="searchBtn">Search</button>

    <div class="label-with-info">
      <span>Employee Name</span>
      <button class="info-btn" id="historyBtn">History</button>
    </div>
    <input type="text" id="employeeName" readonly placeholder="Employee Name">
  </div>

  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr><th>Unit</th><th>Plan</th><th>Operation</th><th>Pcs</th><th>Rate</th><th>Amount</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="5">Total Amount</td><td id="totalAmount">0</td></tr></tfoot>
    </table>
  </div>

  <div class="button-container">
    <button id="downloadBtn">Download PDF</button>
    <button id="correctionBtn">Correction Request</button>
  </div>

  <!-- HISTORY MODAL -->
  <div class="history-overlay" id="historyOverlay" style="display:none;">
    <div class="history-modal">
      <div class="history-header">
        <span>Complaint History</span>
        <button class="close-history" id="closeHistory">X</button>
      </div>
      <div id="historyList">
        <div class="no-history">No complaints found.</div>
      </div>
    </div>
  </div>

  <script>
    // FIREBASE CONFIG
    firebase.initializeApp({
      apiKey: "AIzaSyBUZIjPpELrGAgfs49zTQrWAN8MpI_HKgo",
      authDomain: "wages-portal.firebaseapp.com",
      databaseURL: "https://wages-portal-default-rtdb.firebaseio.com",
      projectId: "wages-portal"
    });
    const db = firebase.database();
    let allData = [];

    // LOAD DATA
    db.ref('excelData').on('value', s => allData = s.val() || []);
    const nameSpan = document.getElementById('loadedFileName');
    db.ref('excelFile/name').on('value', s => {
      nameSpan.textContent = s.val() || 'No file loaded';
    });

    // NORMALIZE UNITS
    function normalizeUnits(input) {
      if (!input) return '';
      return input
        .split(',')
        .map(u => u.trim())
        .filter(u => u)
        .map(u => {
          const match = u.toString().match(/(\d+)/);
          return match ? `UNIT-${match[0].padStart(2, '0')}` : '';
        })
        .filter(u => u)
        .join(', ');
    }

    // ELEMENTS
    const refreshFileBtn = document.getElementById('refreshFileBtn');
    const searchBtn = document.getElementById('searchBtn');
    const employeeNameInput = document.getElementById('employeeName');
    const dataTableBody = document.querySelector('#dataTable tbody');
    const totalAmountCell = document.getElementById('totalAmount');
    const downloadBtn = document.getElementById('downloadBtn');
    const correctionBtn = document.getElementById('correctionBtn');
    const codeInput = document.getElementById('code');
    const historyBtn = document.getElementById('historyBtn');
    const historyOverlay = document.getElementById('historyOverlay');
    const closeHistory = document.getElementById('closeHistory');
    const historyList = document.getElementById('historyList');

    let selectedRowData = null;
    const popups = { correction: null, operation: null };
    let currentEmployee = { code: '', name: '' };
    let currentRowData = { unit: '', plan: '', operation: '', pcs: '' };

    // NO LOADING MESSAGE ON START
    window.onload = () => {
      const complaintData = localStorage.getItem('showComplaintCard');
      if (complaintData) {
        try {
          const data = JSON.parse(complaintData);
          showComplaintCard(data);
        } catch (e) {
          localStorage.removeItem('showComplaintCard');
        }
        return;
      }
      const saved = localStorage.getItem('lastEmployeeSearch');
      if (saved) {
        const { code } = JSON.parse(saved);
        codeInput.value = code;
        searchBtn.click();
      }
    };

    // REFRESH
    refreshFileBtn.addEventListener('click', () => {
      codeInput.value = '';
      employeeNameInput.value = '';
      dataTableBody.innerHTML = '';
      totalAmountCell.textContent = '0';
      selectedRowData = null;
      document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
      localStorage.removeItem('lastEmployeeSearch');
      showToast('Refreshed!');
    });

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.textContent = msg;
      toast.style.position = 'fixed'; toast.style.bottom = '20px'; toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)'; toast.style.background = '#0b3d91';
      toast.style.color = 'white'; toast.style.padding = '6px 12px'; toast.style.borderRadius = '16px';
      toast.style.fontSize = '11px'; toast.style.zIndex = '1000'; toast.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 1200);
    }

    // HISTORY
    function showHistory() {
      const code = codeInput.value.trim();
      if (!code) return;
      historyList.innerHTML = '<div class="no-history">Loading...</div>';

      db.ref('complaints').orderByChild('code').equalTo(code).once('value')
        .then(snap => {
          const complaints = [];
          snap.forEach(child => {
            const data = child.val();
            data.key = child.key;
            data.status = data.status || 'pending';
            complaints.push(data);
          });

          if (complaints.length === 0) {
            historyList.innerHTML = '<div class="no-history">No complaints found.</div>';
            return;
          }

          complaints.sort((a, b) => b.timestamp - a.timestamp);
          historyList.innerHTML = complaints.map(c => {
            const statusText = c.status === 'done' ? 'Done' : c.status === 'verifying' ? 'Verifying..' : 'Pending..';
            const statusClass = `status-${c.status}`;
            const lines = c.text.split('\n').map(line => {
              const isUrdu = /[\u0600-\u06FF]/.test(line);
              return `<p style="margin:0.3rem 0;" ${isUrdu ? 'class="rtl"' : ''}>${line}</p>`;
            }).join('');
            return `
              <div class="history-item">
                <div><strong>Code:</strong> ${c.code}</div>
                ${lines}
                <span class="status-badge ${statusClass}">${statusText}</span>
                <small>${new Date(c.timestamp).toLocaleString()}</small>
                <button class="delete-complaint" data-key="${c.key}">Del</button>
              </div>
            `;
          }).join('');

          document.querySelectorAll('.delete-complaint').forEach(btn => {
            btn.addEventListener('click', function() {
              const key = this.getAttribute('data-key');
              if (confirm('Delete this complaint?')) {
                db.ref('complaints/' + key).remove()
                  .then(() => { showHistory(); showToast('Deleted!'); })
                  .catch(() => showToast('Delete failed!'));
              }
            });
          });
        })
        .catch(() => {
          historyList.innerHTML = '<div class="no-history">Error loading history.</div>';
        });

      historyOverlay.style.display = 'flex';
    }

    closeHistory.addEventListener('click', () => historyOverlay.style.display = 'none');
    historyOverlay.addEventListener('click', (e) => { if (e.target === historyOverlay) historyOverlay.style.display = 'none'; });
    historyBtn.addEventListener('click', showHistory);

    // SEARCH
    searchBtn.addEventListener('click', () => {
      const code = codeInput.value.trim();
      if (!code) return alert('Enter code!');
      if (!allData.length) return alert('Data loading...');
      const rows = allData.filter(r => r.EMPCODE == code);
      if (rows.length === 0) {
        alert('Not found!'); employeeNameInput.value = ''; dataTableBody.innerHTML = ''; totalAmountCell.textContent = '0'; return;
      }
      employeeNameInput.value = rows[0].EMPNAME || '';
      currentEmployee = { code, name: rows[0].EMPNAME || '' };
      localStorage.setItem('lastEmployeeSearch', JSON.stringify(currentEmployee));
      dataTableBody.innerHTML = ''; let total = 0;
      rows.forEach(row => {
        const amt = Math.round(parseFloat(row.AMT) || 0); total += amt;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.DEPT_NAME}</td><td>${row.PLANNO}</td><td>${row.OPRNAME}</td><td>${row.QTY}</td><td>${row.RATE}</td><td>${amt.toLocaleString()}</td>`;
        tr.onclick = () => {
          if (tr.classList.contains('selected')) {
            tr.classList.remove('selected');
            selectedRowData = null;
          } else {
            document.querySelectorAll('tr.selected').forEach(r => r.classList.remove('selected'));
            tr.classList.add('selected');
            selectedRowData = { unit: row.DEPT_NAME, plan: row.PLANNO, operation: row.OPRNAME, pcs: row.QTY };
          }
        };
        tr.ondblclick = () => openOperationView(row.DEPT_NAME, row.PLANNO, row.OPRNAME);
        dataTableBody.appendChild(tr);
      });
      totalAmountCell.textContent = total.toLocaleString();
    });

    // POPUP
    function openFullscreenPopup(title, contentHTML, rowData) {
      const win = window.open('', `_blank_${Date.now()}`, 'width=100%,height=100%,scrollbars=yes');
      if (!win) { alert('Pop-up blocked! Allow pop-ups.'); return null; }
      localStorage.setItem('correctionTempData', JSON.stringify({ employee: currentEmployee, row: rowData }));
      win.document.write(`
        <!DOCTYPE html>
        <html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>${title}</title>
        <style>
          *{margin:0;padding:0;box-sizing:border-box;}
          body{font-family:Segoe UI;background:linear-gradient(to bottom right,#a9d6ff,#e6f3ff);padding:1rem;display:flex;flex-direction:column;align-items:center;min-height:100vh;}
          h2{color:#0b3d91;font-size:1.6rem;margin:0.5rem 0 1rem;text-align:center;}
          .card{background:white;border-radius:12px;padding:1rem;box-shadow:0 4px 12px rgba(0,0,0,0.2);width:100%;max-width:500px;margin-bottom:1rem;}
          .navy-btn{width:100%;padding:12px;margin-top:1rem;background:#0b3d91;color:white;border:none;border-radius:10px;font-weight:bold;font-size:1rem;cursor:pointer;}
          .navy-btn:hover{background:#094080;}
          .rtl{direction:rtl;text-align:right;font-family:'Noto Nastaliq Urdu',Arial,sans-serif;}
          .operation-input{width:180px !important;}
          .close-btn{position:fixed;bottom:15px;left:50%;transform:translateX(-50%);width:90%;max-width:480px;padding:0.9rem;background:#0b3d91;color:white;border:none;border-radius:12px;font-size:1.1rem;font-weight:bold;cursor:pointer;}
          .close-btn:hover{background:#094080;}
        </style>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet">
        </head>
        <body>
          <h2>${title}</h2>
          ${contentHTML}
          <button class="close-btn" onclick="window.close()">Close</button>
          <script>
            function normalizeUnits(input) {
              if (!input) return '';
              return input.split(',').map(u => u.trim()).filter(u => u).map(u => {
                const m = u.match(/(\\d+)/); return m ? 'UNIT-' + m[0].padStart(2,'0') : '';
              }).filter(u => u).join(', ');
            }
            function makeCard() {
              document.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field'));
              const temp = JSON.parse(localStorage.getItem('correctionTempData') || '{}');
              const emp = temp.employee || {}; const row = temp.row || {};
              const opt1 = document.getElementById('opt1')?.checked;
              const opt2 = document.getElementById('opt2')?.checked;
              const opt3 = document.getElementById('opt3')?.checked;
              const desc = document.getElementById('correctionDesc')?.value.trim();
              let valid = true;
              if ((opt1 || opt2) && (!row.unit || !row.plan || !row.operation || !row.pcs)) {
                alert('Please select a row!'); valid = false;
              }
              if (!opt1 && !opt2 && !opt3) { alert('Please select an option!'); valid = false; }
              let complaintText = '';
              const dataLine = \`Unit: \${row.unit}, Plan: \${row.plan}, Operation: \${row.operation}, Pcs: \${row.pcs}\`;
              if (opt1) {
                const pcs1 = document.getElementById('pcs1');
                if (!pcs1.value.trim()) { pcs1.classList.add('invalid-field'); pcs1.focus(); valid = false; }
                else complaintText = dataLine + \`\\nمیں نے یونٹ-\${row.unit}، پلان \${row.plan}، آپریشن \${row.operation} کے \${pcs1.value.trim()} پیس سلائی کیے ہیں۔\`;
              }
              if (opt2) complaintText = dataLine + \`\\nیہ پیس میرے نہیں ہیں۔ نکال دیں۔\`;
              if (opt3) {
                const u = document.getElementById('unit3'), p = document.getElementById('plan3'), o = document.getElementById('op3'), pcs = document.getElementById('pcs3');
                if (!u.value.trim()) { u.classList.add('invalid-field'); u.focus(); valid = false; }
                if (!p.value.trim()) { p.classList.add('invalid-field'); p.focus(); valid = false; }
                if (!o.value.trim()) { o.classList.add('invalid-field'); o.focus(); valid = false; }
                if (!pcs.value.trim()) { pcs.classList.add('invalid-field'); pcs.focus(); valid = false; }
                if (valid) {
                  const newDataLine = \`Unit: \${u.value.trim()}, Plan: \${p.value.trim()}, Operation: \${o.value.trim()}, Pcs: \${pcs.value.trim()}\`;
                  complaintText = newDataLine + \`\\nیونٹ \${u.value.trim()} پلان \${p.value.trim()} آپریشن \${o.value.trim()} کے \${pcs.value.trim()} پیس سلائی کیے ہیں۔ فیڈ کر دیں۔\`;
                }
              }
              if (desc) complaintText += \`\\n\\nNote: \${desc}\`;
              if (!valid) return;

              let unit = (opt1 || opt2) ? row.unit : document.getElementById('unit3').value.trim();
              const normalizedUnit = normalizeUnits(unit);

              const complaint = { 
                code: emp.code, name: emp.name, unit: normalizedUnit, 
                text: complaintText, timestamp: Date.now(), status: 'pending'
              };

              window.opener.firebase.database().ref('complaints').push(complaint)
                .then(() => {
                  window.opener.localStorage.setItem('showComplaintCard', JSON.stringify(complaint));
                  window.opener.location.reload();
                  window.close();
                })
                .catch(err => alert('Save failed: ' + err.message));
            }
          <\/script>
        </body></html>
      `);
      win.document.close();
      return win;
    }

    // CORRECTION REQUEST
    function openCorrectionRequest() {
      if (popups.correction && !popups.correction.closed) { popups.correction.focus(); return; }
      const empCode = codeInput.value.trim(), empName = employeeNameInput.value.trim();
      if (!empCode || !empName) return alert('Please search an employee first!');
      currentEmployee = { code: empCode, name: empName };
      currentRowData = selectedRowData ? { ...selectedRowData } : { unit: '', plan: '', operation: '', pcs: '' };

      const content = `
        <div class="card">
          <div style="font-size:0.9rem;color:#0b3d91;line-height:1.4;">
            <p><strong>Code:</strong> ${empCode}</p>
            <p><strong>Name:</strong> ${empName}</p>
            <p><strong>Unit:</strong> ${currentRowData.unit || '—'}</p>
            <p><strong>Plan:</strong> ${currentRowData.plan || '—'}</p>
            <p><strong>Operation:</strong> ${currentRowData.operation || '—'}</p>
            <p><strong>Pcs:</strong> ${currentRowData.pcs || '—'}</p>
          </div>
          <div style="margin-top:1rem; display: flex; flex-direction: column; gap: 0.8rem; font-size: 0.9rem;">
            <label style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
              <input type="radio" name="opt" id="opt1" style="width: 15px; height: 15px;"> 
              <span style="font-weight: bold;">I have stitched</span>
              <input type="text" id="pcs1" placeholder="Pcs" style="width: 60px; padding: 0.3rem; border: none; border-bottom: 1px solid #0b3d91;">
              <span style="font-weight: bold;">pieces.</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.4rem;">
              <input type="radio" name="opt" id="opt2" style="width: 15px; height: 15px;"> 
              <span style="font-weight: bold;">These are not my pieces. Remove them.</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
              <input type="radio" name="opt" id="opt3" style="width: 15px; height: 15px;"> 
              <span style="font-weight: bold;">Feed</span>
              <input type="text" id="unit3" placeholder="Unit" style="width: 60px; padding: 0.3rem; border: none; border-bottom: 1px solid #0b3d91;">
              <span style="font-weight: bold;">plan</span>
              <input type="text" id="plan3" placeholder="Plan" style="width: 60px; padding: 0.3rem; border: none; border-bottom: 1px solid #0b3d91;">
              <span style="font-weight: bold;">operation</span>
              <input type="text" id="op3" class="operation-input" placeholder="Operation" style="width: 180px; padding: 0.3rem; border: none; border-bottom: 1px solid #0b3d91;">
              <span style="font-weight: bold;">pieces:</span>
              <input type="text" id="pcs3" placeholder="Pcs" style="width: 50px; padding: 0.3rem; border: none; border-bottom: 1px solid #0b3d91;">
            </label>
          </div>
          <textarea id="correctionDesc" placeholder="Describe correction (optional)..." style="width: 100%; margin-top: 1rem; padding: 0.6rem; border-radius: 8px; border: 1px solid #0b3d91; font-size: 0.9rem; min-height: 70px; resize: vertical;"></textarea>
          <button class="navy-btn" onclick="makeCard()">Make Complaint Card</button>
        </div>
      `;

      const win = openFullscreenPopup('Correction Request', content, currentRowData);
      if (win) { popups.correction = win; win.onunload = () => popups.correction = null; }
    }

    // SHOW COMPLAINT CARD — ONLY CLOSES CARD, NOT MAIN PAGE
    function showComplaintCard(data) {
      const lines = data.text.split('\n');
      const formatted = lines.map(l => `<p class="${l.includes('پیس') ? 'rtl complaint-text' : ''}" style="margin:0.6rem 0;">${l}</p>`).join('');
      document.body.innerHTML = `
        <div style="padding:1rem;display:flex;flex-direction:column;align-items:center;min-height:100vh;background:linear-gradient(to bottom right,#a9d6ff,#e6f3ff);">
          <h2 style="color:#0b3d91;font-size:1.6rem;margin:1rem 0;">Complaint Card</h2>
          <div id="cardArea" class="card" style="width:95%;max-width:500px;background:white;padding:1.2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
            <p style="margin:0.5rem 0;font-size:1rem;color:#0b3d91;"><strong>Code:</strong> ${data.code}</p>
            <p style="margin:0.5rem 0;font-size:1rem;color:#0b3d91;"><strong>Name:</strong> ${data.name}</p>
            <div style="margin-top:1.5rem;padding:1.2rem;background:#f9f9f9;border-radius:8px;">
              ${formatted}
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:1rem;width:95%;max-width:500px;flex-wrap:wrap;justify-content:center;">
            <button class="card-btn" onclick="alert('Submitted!');">Submit Request</button>
            <button class="card-btn" onclick="shareToWhatsApp()">Share to WhatsApp</button>
            <button class="card-btn" onclick="closeComplaintCard()">Close</button>
          </div>
        </div>
      `;

      // SHARE IMAGE
      window.shareToWhatsApp = () => {
        const cardArea = document.getElementById('cardArea');
        html2canvas(cardArea, { scale: 2, useCORS: true, backgroundColor: '#ffffff' })
          .then(canvas => {
            canvas.toBlob(blob => {
              const file = new File([blob], 'complaint.png', { type: 'image/png' });
              if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ files: [file], title: 'Complaint Card' })
                  .catch(() => fallbackShare(canvas.toDataURL('image/png')));
              } else {
                fallbackShare(canvas.toDataURL('image/png'));
              }
            }, 'image/png');
          })
          .catch(() => alert('Failed to capture image!'));
      };

      function fallbackShare(imgData) {
        const link = document.createElement('a');
        link.href = imgData;
        link.download = 'complaint.png';
        link.click();
      }

      // FIXED: ONLY CLOSES CARD, RETURNS TO MAIN FORM
      window.closeComplaintCard = () => {
        localStorage.removeItem('showComplaintCard');
        // Just reload main window — card is in same tab
        window.location.reload();
      };
    }

    // DOWNLOAD PDF
    downloadBtn.addEventListener('click', () => {
      const code = codeInput.value.trim(), name = employeeNameInput.value;
      if (!code || !name || dataTableBody.children.length === 0) return alert('Search first!');
      try {
        const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 15;
        doc.setFontSize(12);
        doc.text(`File: ${nameSpan.textContent}`, 10, y); y += 10;
        doc.text(`Code: ${code}`, 10, y); y += 10; doc.text(`Name: ${name}`, 10, y); y += 15;
        const headers = ['Unit', 'Plan', 'Operation', 'Pcs', 'Rate', 'Amount'];
        const data = Array.from(dataTableBody.children).map(r => Array.from(r.cells).map(c => c.textContent));
        doc.autoTable({ startY: y, head: [headers], body: data, theme: 'grid', styles: { fontSize: 10 }, headStyles: { fillColor: [11,61,145] } });
        y = doc.lastAutoTable.finalY + 10; doc.text(`Total: ${totalAmountCell.textContent}`, 10, y);
        doc.save(`${code.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
      } catch { alert('PDF failed!'); }
    });

    correctionBtn.addEventListener('click', openCorrectionRequest);

    // OPERATION VIEW
    function openOperationView(unit, plan, operation) {
      const rows = allData.filter(r => r.DEPT_NAME === unit && r.PLANNO === plan && r.OPRNAME === operation);
      if (rows.length === 0) return alert('No data!');
      const totalPcs = rows.reduce((s, r) => s + (parseInt(r.QTY) || 0), 0);
      const totalAmt = rows.reduce((s, r) => s + (Math.round(parseFloat(r.AMT) || 0)), 0);
      const content = `
        <div style="color:#0b3d91;font-size:0.9rem;font-weight:bold;text-align:center;margin-bottom:0.8rem;">
          Unit: ${unit} | Plan: ${plan} | Operation: ${operation}
        </div>
        <div class="card">
          <table style="width:100%;border-collapse:collapse;font-size:0.75rem;">
            <thead style="background:#0b3d91;color:white;">
              <tr><th>Code</th><th>Name</th><th>Pcs</th><th>Rate</th><th>Amt</th></tr>
            </thead>
            <tbody>
              ${rows.map(r => `
                <tr style="border-bottom:1px solid #eee;">
                  <td style="padding:0.3rem;text-align:center;">${r.EMPCODE}</td>
                  <td style="padding:0.3rem;">${r.EMPNAME}</td>
                  <td style="padding:0.3rem;text-align:center;">${(parseInt(r.QTY)||0).toLocaleString()}</td>
                  <td style="padding:0.3rem;text-align:center;">${r.RATE}</td>
                  <td style="padding:0.3rem;text-align:right;">${Math.round(parseFloat(r.AMT)||0).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="background:#f1f1f1;font-weight:bold;">
                <td colspan="2" style="padding:0.35rem;text-align:center;">Total</td>
                <td style="padding:0.35rem;text-align:center;">${totalPcs.toLocaleString()}</td>
                <td>-</td>
                <td style="padding:0.35rem;text-align:right;">${totalAmt.toLocaleString()}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
      const win = openFullscreenPopup('Operation Wise Report', content, {});
      if (win) popups.operation = win;
    }
  </script>
</body>
</html>