<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#a9d6ff;font-family:Arial;min-height:100vh;padding:8px 10px;display:flex;flex-direction:column;gap:4px;overflow:hidden;}
    h1{color:#0b3d91;font-size:20px;text-align:center;margin-bottom:2px;}
    input{width:100%;padding:9px;margin:2px 0;border-radius:6px;font-size:14px;border:2px solid #0b3d91;background:#fff;}
    input[type=password]{-webkit-text-security:disc;}
    button{padding:12px 16px;border:none;border-radius:8px;color:#fff;font-weight:bold;font-size:15px;cursor:pointer;}
    .bigBtn{width:100%;}
    .edit{background:#1e90ff;}
    .del{background:#e63946;}
    .add{background:#0b3d91;}
    
    .fileSection{
      display:flex; flex-direction:column; align-items:flex-start; gap:2px; margin:2px 0; font-size:14px;
    }
    .uploadRow{
      display:flex; align-items:center; gap:10px;
    }
    
    .tableContainer{
      max-height:330px; overflow-y:auto; overflow-x:hidden; border-radius:8px;
      box-shadow:0 2px 6px #0003; margin-top:4px;
    }
    table{width:100%;font-size:12px;border-collapse:collapse;background:#fff;}
    th,td{border:1px solid #ccc;padding:5px;text-align:center;}
    th{
      background:#006400 !important; color:white !important; font-weight:bold;
      padding:12px 5px !important; font-size:14px; position:sticky; top:0; z-index:1;
    }
    td{ font-weight:bold; color:#0b3d91; }

    .statusLine{
      display:flex; align-items:center; justify-content:space-between;
      font-weight:bold; color:#0b3d91; font-size:14px; margin:2px 0;
    }

    .fileInput{display:none;}
    .uploadBtnSmall{background:#0b3d91;color:white;padding:8px 12px;border-radius:6px;font-size:13px;cursor:pointer;}
    .addSlimBtn{width:100%;padding:10px 16px;font-size:14px;}
    .fileNameText{color:#0b3d91;font-weight:bold;}
    .deleteText{
      color:#e63946; font-weight:bold; font-size:13px; cursor:pointer;
      text-decoration:underline; background:none; border:none; padding:0;
    }
    .logoutSmall{
      background:#e74c3c; color:white; padding:8px 12px; border-radius:6px;
      font-size:13px; font-weight:bold; cursor:pointer; align-self:flex-start; margin-top:6px;
    }
  </style>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>

  <h1>ADMIN PANEL</h1>

  <div class="fileSection">
    <div class="uploadRow">
      <div class="uploadBtnSmall" onclick="document.getElementById('excelFile').click()">UPLOAD</div>
      <input type="file" id="excelFile" class="fileInput" accept=".xlsx,.xls" onchange="uploadExcelAuto()">
      <span>Loaded File:</span>
      <span id="fileNameDisplay" class="fileNameText">No file</span>
    </div>
  </div>

  <div class="statusLine">
    <div id="status">Ready</div>
    <span class="deleteText" id="deleteFileBtn" style="display:none;" onclick="deleteFile()">Delete File</span>
  </div>

  <input type="text" id="userName" placeholder="Name">
  <input type="password" id="password" placeholder="Password">
  <input type="text" id="unit" placeholder="Unit (e.g. 12,14 or UNIT-12, UNIT-14)">
  <button class="add bigBtn addSlimBtn" onclick="saveUser()">Add User</button>

  <div class="tableContainer">
    <table id="userTable">
      <thead><tr><th>Name</th><th>Password</th><th>Unit</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="logoutSmall" onclick="localStorage.clear();location='index.html'">Logout</div>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>

  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyBUZIjPpELrGAgfs49zTQrWAN8MpI_HKgo",
      authDomain: "wages-portal.firebaseapp.com",
      databaseURL: "https://wages-portal-default-rtdb.firebaseio.com",
      projectId: "wages-portal"
    });
    const db = firebase.database();
    if(localStorage.getItem('adminLoggedIn')!=='true') location='ap.html';

    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const status = document.getElementById('status');
    const deleteFileBtn = document.getElementById('deleteFileBtn');

    function showFile(){
      db.ref('excelFile/name').once('value', s => {
        const name = s.val();
        fileNameDisplay.textContent = name || 'No file';
        deleteFileBtn.style.display = name ? 'inline-block' : 'none';
      });
    }
    db.ref('excelFile/name').on('value', showFile);
    showFile();

    window.deleteFile = () => {
      if(!confirm('Delete uploaded file from Firebase?')) return;
      status.textContent = 'Deleting...';
      Promise.all([
        db.ref('excelData').remove(),
        db.ref('excelFile/name').remove()
      ]).then(() => {
        status.textContent = 'Ready';
        setTimeout(() => status.textContent = 'Ready', 3000);
      }).catch(err => {
        status.textContent = 'Delete failed: ' + err.message;
      });
    };

    window.uploadExcelAuto = () => {
      const file = document.getElementById('excelFile').files[0];
      if (!file) return;

      const ext = file.name.toLowerCase().split('.').pop();
      if (!['xlsx', 'xls'].includes(ext)) {
        status.textContent = 'Only .xlsx or .xls allowed!';
        return;
      }

      status.textContent = 'Reading file...';
      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          if (!workbook.SheetNames.length) {
            status.textContent = 'No sheets found!';
            return;
          }

          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });

          if (!json || json.length === 0) {
            status.textContent = 'Excel is empty!';
            return;
          }

          status.textContent = 'Uploading...';
          const fileName = file.name.replace(/\.[^/.]+$/, "");

          Promise.all([
            db.ref('excelData').set(json),
            db.ref('excelFile/name').set(fileName)
          ]).then(() => {
            status.innerHTML = 'SUCCESS!<br>JSON LIVE!';
            fileNameDisplay.textContent = fileName;
            deleteFileBtn.style.display = 'inline-block';
            document.getElementById('excelFile').value = '';
            setTimeout(() => status.textContent = 'Ready', 4000);
          }).catch(err => {
            status.textContent = 'Upload failed: ' + err.message;
            console.error(err);
          });

        } catch (err) {
          status.textContent = 'Invalid Excel file!';
          console.error('Parse Error:', err);
        }
      };

      reader.onerror = () => status.textContent = 'File read failed!';
      reader.readAsArrayBuffer(file);
    };

    // FINAL: normalizeUnits — ANY INPUT → UNIT-12, UNIT-14
    function normalizeUnits(input) {
      if (!input) return '';
      return input
        .split(',')
        .map(u => u.trim())
        .filter(u => u)
        .map(u => {
          const match = u.toString().match(/(\d+)/);
          return match ? `UNIT-${match[0].padStart(2, '0')}` : '';
        })
        .filter(u => u)
        .join(', ');
    }

    let editKey = null;
    const tbody = document.querySelector('#userTable tbody');
    db.ref('users').on('value', s => {
      tbody.innerHTML = '';
      s.forEach(c => {
        const u = c.val();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.name}</td><td>${u.password}</td><td>${u.unit}</td>
          <td><div style="display:flex;gap:6px;justify-content:center;">
            <button class="edit" style="padding:8px 0;width:48%;font-size:12px;" onclick="edit('${c.key}','${u.name}','${u.password}','${u.unit}')">Edit</button>
            <button class="del" style="padding:8px 0;width:48%;font-size:12px;" onclick="del('${c.key}')">Del</button>
          </div></td>`;
        tbody.appendChild(tr);
      });
    });

    window.edit = (k, n, p, u) => {
      document.getElementById('userName').value = n;
      document.getElementById('password').value = p;
      document.getElementById('unit').value = u;
      editKey = k;
    };

    window.del = k => confirm('Delete?') && db.ref('users/' + k).remove();

    window.saveUser = () => {
      const n = document.getElementById('userName').value.trim();
      const p = document.getElementById('password').value.trim();
      const rawUnits = document.getElementById('unit').value.trim();
      if (!n || !p || !rawUnits) return alert('Fill all');

      const normalizedUnits = normalizeUnits(rawUnits); // → UNIT-12, UNIT-14
      const data = { name: n, password: p, unit: normalizedUnits };

      if (editKey) {
        db.ref('users/' + editKey).update(data).then(() => { editKey = null; clear(); });
      } else {
        db.ref('users').push(data).then(() => { clear(); });
      }
    };

    function clear() {
      ['userName', 'password', 'unit'].forEach(id => document.getElementById(id).value = '');
    }
  </script>
</body>
</html>